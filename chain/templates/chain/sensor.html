{% extends "chain/base.html" %}

{% block title %}Sensor{% endblock %}

{% block body %}

<div class="" id="Left_Side">

{% if mynodes %}

<div class="">
  <table class="table">
    <thead>
      <tr>
        <div class="" id="sensor_table">
          <th>Sensor_name</th>
        </div>
        <div class="" id="last_update">
          <th>Last Update</th>
        </div>
        <div class="" id="plot_table">
          <th>Plot</th>
        </div>
      </tr>
    </thead>
    <tbody>

              {% for nodes in  mynodes %}
                  {% if nodes.sensor_set.all %}
                  {% for  node in nodes.sensor_set.all %}
                        <tr>
                          {%if forloop.counter == 1 %}
                            <script type="text/javascript">
                              var test = '{{node.name}}';
                              var number = 21;
                            </script>
                          {%endif%}
                          <div class="" id="sensor_table">
                            <td><a href ="/chain/data/?name={{node.name}}"> {{node.name}}  </a></td>
                          </div>
                          <div class="" id="last_update">
                            {%if node.data_set.all %}
                              {%for data in node.data_set.all %}
                                {%if forloop.counter == 1 %}
                                  <td> {{data.doc}} </td>
                                {%endif%}
                              {%endfor%}
                            {%else%}
                              <td>  Not Updated </td>
                            {%endif%}
                          </div>
                          <div class="" id="plot_table">
                            <td>
                            <button onclick="final('{{node.name}}',21)">Plot</button>
                            </td>
                          </div>
                        </tr>
                        {%endfor%}
                      </tbody>
                    </table>
                  </div>
          {% else %}
          {%endif%}

      {% endfor %}

{% else %}


{% endif %}

</div>


{% endblock %}



{% block body_right %}

{%if mynodes%}

<div class="" id="Right_Side">
  <!DOCTYPE html>
  {% load staticfiles %}
  <meta charset="utf-8">
  <script src="{% static '/chain/react.min.js' %}"></script>
  <script src="{% static '/chain/react-dom.min.js' %}"></script>
  <script src="{% static '/chain/browser.min.js' %}"></script>
  <link type="text/css" rel="stylesheet" href="{% static '/chain/rickshaw.min.css' %}">
  <script src="{% static '/chain/d3.min.js' %}"></script>
  <script src="{% static '/chain/d3.layout.min.js' %}"></script>
  <script src="{% static '/chain/rickshaw.min.js' %}"></script>
  <style>
#csv{
  margin-left: 40px;
  margin-right: 10px;
  margin-top: 20px;
}

#sensor{
  margin-left: 40px;
  margin-right: 10px;
  margin-top: 10px;
}

#chart_container {
        display: inline-block;
        font-family: Arial, Helvetica, sans-serif;
}
#chart {
        display: inline-block;
        margin-left: 40px;
        margin-right: 10px;
        margin-top: 40px;
}

#offset_form {
        margin-top: 40px;
        margin-left: 40px;
        font-size: 15px;
}
#y_axis {
        position: absolute;
        top: 77;
        bottom: 0;
        width: 40px;
}
</style>

<div id="chart_container">
        <div id="y_axis"></div>
        <div id="chart"></div>
        <div id="legend"></div>
        <form id="offset_form" class="toggler">
                <input type="radio" name="offset" id="lines" value="lines" checked>
                <label class="lines" for="lines">lines</label><br>
                <input type="radio" name="offset" id="stack" value="zero">
                <label class="stack" for="stack">stack</label>
        </form>
</div>
<div id="sensor"></div>
<div id="csv"> </div>
<script>
var arr = [];
var temp = [];
function plot(i,j)
{
  while (arr.length > 0) {
  arr.pop();
  }
  while (temp.length > 0) {
  temp.pop();
  }
  var lol = j;
  var test = i;
  {% for nodes in  mynodes %}
  {% for sensor in nodes.sensor_set.all %}
  if (test == "{{sensor.name}}")
  {
    {% for data in  sensor.data_set.all %}
    if ({{forloop.counter}} < lol)
    {
      var dict = {};
      dict["x"] = parseInt({{ data.doc|date:"U"}});
      dict["y"] = parseInt({{data.data}});
      temp.push(dict);
    }
    {%endfor%}
  }
  for (var i = 0; i < lol-1; i++) {
    arr[i] = temp[lol-2-i];
  }
  {%endfor%}
  {%endfor%}
}

function final(i,j) {
    var s = "<h4> <a href =" + '/chain/test/' + i + "> Click </a> Here to download your data for this sensor as .csv file </h4>";
    document.getElementById('sensor').innerHTML = "<h4> This plot is for sensor " + i + "--last 20 data point </h4>";
    document.getElementById('csv').innerHTML = s;
    plot(i,j);
    graph.render();
}

var palette = new Rickshaw.Color.Palette();
var graph = new Rickshaw.Graph( {
        element: document.querySelector("#chart"),
        width: 540,
        height: 240,
        renderer: 'line',
        series: [
                {
                        data: arr,
                        color: palette.color()
                },
        ]
} );

var x_axis = new Rickshaw.Graph.Axis.Time( { graph: graph } );
var y_axis = new Rickshaw.Graph.Axis.Y( {
        graph: graph,
        orientation: 'left',
        tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
        element: document.getElementById('y_axis'),
} );
var offsetForm = document.getElementById('offset_form');
offsetForm.addEventListener('change', function(e) {
        var offsetMode = e.target.value;

        if (offsetMode == 'lines') {
                graph.setRenderer('line');
                graph.offset = 'zero';
        } else {
                graph.setRenderer('stack');
                graph.offset = offsetMode;
        }
        graph.render();
}, false);
final(test,11);
final(test,21);
</script>
</div>

{%endif%}
{% endblock body_right %}
